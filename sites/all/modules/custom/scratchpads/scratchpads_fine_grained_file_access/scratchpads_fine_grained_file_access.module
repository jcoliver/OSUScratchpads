<?php

/**
 * This module should follow http://drupal.org/node/1227706 as that issue looks
 * to be solving this problem in a much better way.
 */
/**
 * Implements hook_menu_alter().
 */
function scratchpads_fine_grained_file_access_menu_alter(&$items){
  // We set a number of paths to have different access rights.
  $items['file/add']['access callback'] = 'scratchpads_fine_grained_file_access_access';
  $items['file/add']['access arguments'] = array(
    'add'
  );
  $items['file/%file']['access callback'] = 'scratchpads_fine_grained_file_access_access';
  $items['file/%file']['access arguments'] = array(
    'view',
    1
  );
  $items['file/%file/edit']['access callback'] = 'scratchpads_fine_grained_file_access_access';
  $items['file/%file/edit']['access arguments'] = array(
    'edit',
    1
  );
  $items['file/%file/delete']['access callback'] = 'scratchpads_fine_grained_file_access_access';
  $items['file/%file/delete']['access arguments'] = array(
    'delete',
    1
  );
}

/**
 * Implements hook_permission().
 */
function scratchpads_fine_grained_file_access_permission(){
  // Following permissions are required:
  // create file
  // edit all file
  // edit own file
  // delete all file
  // delete own file
  // 
  // Following permission are not required:
  // view file (already defined by file_entity)
  return array(
    'create file' => array(
      'title' => 'Create file'
    ),
    'edit all file' => array(
      'title' => 'Edit all files'
    ),
    'edit own file' => array(
      'title' => 'Edit own files'
    ),
    'delete all file' => array(
      'title' => 'Delete all files'
    ),
    'delete own file' => array(
      'title' => 'Delete own files'
    )
  );
}

/**
 * Access control callback for finer control.
 */
function scratchpads_fine_grained_file_access_access($op = 'view', $file = FALSE){
  /*print_r($op);
  print_r($file);
  exit();*/
  global $user;
  switch($op){
    case 'view':
      if(user_access('view file')){
        if(module_exists('scratchpads_group')){
          if($file->{OG_CONTENT_ACCESS_FIELD}[LANGUAGE_NONE][0]['value'] != 1){
            if(isset($file->{OG_AUDIENCE_FIELD}[LANGUAGE_NONE][0]['gid'])){
              $group = og_load($file->{OG_AUDIENCE_FIELD}[LANGUAGE_NONE][0]['gid']);
              $group = $group->getEntity();
              switch($file->{OG_CONTENT_ACCESS_FIELD}[LANGUAGE_NONE][0]['value']){
                case 0:
                  // We're defaulting to the group access.  Check if it is public, or
                  // simply if we have access to the group.
                  if($group->{OG_ACCESS_FIELD}[LANGUAGE_NONE][0]['value'] == 0){return TRUE;}
                case 2:
                  // The file is private, simply do we have access to the group.
                  global $user;
                  $groups = og_get_entity_groups('user', $user);
                  if(isset($groups[$file->{OG_AUDIENCE_FIELD}[LANGUAGE_NONE][0]['gid']])){return TRUE;}
                  break;
              }
            }
          }
        }
      }
      return FALSE;
    case 'edit':
      if(user_access('edit all file')){return TRUE;}
      if($file->uid == $user->uid){return user_access('edit own file');}
      return FALSE;
    case 'delete':
      if(user_access('delete all file')){return TRUE;}
      if($file->uid == $user->uid){return user_access('delete own file');}
      return FALSE;
    case 'add':
      return user_access('create file');
    default:
      return FALSE;
  }
}

/**
 * Implements hook_scratchpads_default_permissions().
 */
function scratchpads_fine_grained_file_access_scratchpads_default_permissions(){
  return array(
    'editor' => array(
      'edit all file',
      'delete all file'
    ),
    'contributor' => array(
      'edit own file',
      'delete own file',
      'create file'
    )
  );
}