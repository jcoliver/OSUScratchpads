<?php

/**
 * Implements hook_menu()
 * 
 * Provide the default configuration pages for adding DwC-A files
 */
function dwcarchiver_menu(){
  return array(
    'admin/config/content/dwcarchiver' => array(
      'title' => 'DwC-Archiver',
      'description' => 'Add and configure custom DwC-Archives.',
      'page callback' => 'dwcarchiver_overview_page',
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc'
    ),
    'admin/config/content/dwcarchiver/add' => array(
      'title' => 'Add DwC-Archive',
      'description' => 'Add custom DwC-Archive',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'dwcarchiver_archive_form'
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc',
      'type' => MENU_LOCAL_ACTION
    ),
    'admin/config/content/dwcarchiver/%dwcarchiver' => array(
      'title callback' => 'dwcarchiver_page_title',
      'title arguments' => array(
        4
      ),
      'page callback' => 'dwcarchiver_page_view',
      'page arguments' => array(
        4
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'title' => 'Edit',
      'page callback' => 'dwcarchiver_edit',
      'page arguments' => array(
        4
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc'
    ),
    'admin/config/content/dwcarchiver/%dwcarchiver/view' => array(
      'title' => 'View',
      'type' => MENU_DEFAULT_LOCAL_TASK
    ),
    'admin/config/content/dwcarchiver/%dwcarchiver/edit' => array(
      'title' => 'Edit',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'dwcarchiver_archive_form',
        4
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc'
    ),
    'admin/config/content/dwcarchiver/%dwcarchiver/delete' => array(
      'title' => 'Delete',
      'page callback' => 'dwcarchiver_delete',
      'page arguments' => array(
        4
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc'
    ),
    'admin/config/content/dwcarchiver/%dwcarchiver/rebuild' => array(
      'title' => 'Rebuild',
      'page callback' => 'dwcarchiver_rebuild',
      'page arguments' => array(
        4
      ),
      'access arguments' => array(
        'configure dwcarchiver'
      ),
      'file' => 'dwcarchiver.pages.inc'
    )
  );
}

/**
 * Implements hook_theme()
 */
function dwcarchiver_theme($existing, $type, $theme, $path){
  return array(
    'dwcarchiver_archive_form' => array(
      'render element' => 'form',
      'file' => 'dwcarchiver.theme.inc'
    ),
    'dwcarchiver_archiver_form_fields_table' => array(
      'render element' => 'element',
      'file' => 'dwcarchiver.theme.inc'
    )
  );
}

/**
 * Return the dwcarchiver object matching a machine name.
 *
 */
function dwcarchiver_machine_name_load($name){
  return db_select('dwcarchiver_archive', 'd')->condition('machine_name', $name)->fields('d')->execute()->fetch();
}

/**
 * Return the dwcarchiver extension object matching a machine name.
 */
function dwcarchiver_extension_machine_name_load($name, $element = FALSE, $form_state = FALSE){
  // Machine names are not globally unique, but are only unique per archive.
  return db_select('dwcarchiver_extension', 'd')->condition('machine_name', $name)->condition('did', $form_state['dwcarchiver']->did)->fields('d')->execute()->fetch();
}

/**
 * Implements hook_menu_alter()
 * 
 * Add the DwC-A paths as defined in the settings above.
 */
function dwcarchiver_menu_alter(&$items){}

/**
 * Implements hook_permission()
 */
function dwcarchiver_permission(){
  return array(
    'configure dwcarchiver' => array(
      'title' => t('Configure DwC-Archiver')
    )
  );
}

/**
 * Load function
 */
function dwcarchiver_load($did){
  $archive = db_select('dwcarchiver_archive', 'd')->fields('d')->condition('did', $did)->execute()->fetch();
  if($archive){
    $archive->extensions = db_select('dwcarchiver_extension', 'e')->fields('e')->condition('did', $did)->execute()->fetchAll();
    $archive->maps = db_select('dwcarchiver_map', 'm')->fields('m')->condition('did', $did)->condition('eid', 0)->execute()->fetchAllAssoc('field');
    foreach($archive->extensions as $key => $value){
      $archive->extensions[$key]->maps = db_select('dwcarchiver_map', 'd')->fields('d')->condition('eid', $value->eid)->execute()->fetchAllAssoc('field');
    }
  }
  return $archive;
}

/**
 * Alter the list of processors
 */
function dwcarchiver_dwcarchiver_processors_alter(&$processors){
  $processors['dwcarchiver_raw_text'] = array(
    'module' => 'dwcarchiver',
    'file' => 'dwcarchiver.processors.inc',
    'callback' => 'dwcarchiver_processor_raw',
    'label' => t('Raw value')
  );
}

/**
 * Implements hook_dwcarchiver_core_types_alter() on behalf of the taxonomy
 * module.
 */
function taxonomy_dwcarchiver_core_types_alter(&$core_types){
  foreach(taxonomy_vocabulary_get_names() as $machine_name => $vocabulary){
    $core_types['taxonomy_term/' . $machine_name] = array(
      'label' => t('Taxonomy term') . " (" . t($vocabulary->name) . ")",
      'links' => array()
    );
  }
  // Loop through all of the taxonomy term fields and add the entity/bundle that
  // they're attached to to the links.
  $entity_info = entity_get_info();
  foreach(field_read_fields(array(
    'type' => 'taxonomy_term_reference'
  )) as $field){
    foreach(field_read_instances(array(
      'field_name' => $field['field_name']
    )) as $instance){
      foreach($field['settings']['allowed_values'] as $allowed_values){
        if(!empty($allowed_values['vocabulary'])){
          $core_types['taxonomy_term/' . $allowed_values['vocabulary']]['links'][$field['field_name'] . '/' . $instance['entity_type'] . '/' . $instance['bundle']] = $instance['label'] . ': ' . $entity_info[$instance['entity_type']]['label'] . " (" . $entity_info[$instance['entity_type']]['bundles'][$instance['bundle']]['label'] . ")";
        }
      }
    }
  }
}